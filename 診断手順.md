# システムエラー診断手順

「システムエラーが発生しました」というエラーが表示される場合の診断手順です。

## 手順1: ブラウザのコンソールでエラー確認

### Chrome/Edgeの場合
1. `index.html`をブラウザで開く
2. `F12`キーを押して開発者ツールを開く
3. 「Console」タブをクリック
4. テストIDを入力して「入場権利を確認」ボタンをクリック
5. コンソールに表示されるエラーログを確認

### 確認すべき内容
以下のようなログが表示されるはずです:

```
=== API呼び出し開始 ===
URL: https://script.google.com/macros/s/...
CAMPFIRE ID: user12345
Response status: 200
Response ok: true
Content-Type: application/json
Response text: {...}
Parsed data: {...}
```

**エラーパターン別の対処法:**

#### パターンA: `TypeError: Failed to fetch`
```
=== API Error ===
Error type: TypeError
Error message: Failed to fetch
```

**原因:** CORSエラー、またはネットワークエラー

**対処法:**
1. Apps Scriptのデプロイ設定を確認（手順2へ）
2. インターネット接続を確認

#### パターンB: `HTTP Error: 403` または `HTTP Error: 401`
```
Response status: 403
HTTP Error: 403 Forbidden
```

**原因:** Apps Scriptのアクセス権限が正しく設定されていない

**対処法:** 手順2でデプロイ設定を確認

#### パターンC: `JSON Parse Error`
```
JSON Parse Error: ...
Response was: <!DOCTYPE html>...
```

**原因:** Apps ScriptがHTMLページを返している（ログインページなど）

**対処法:** Apps Scriptが正しくデプロイされていない可能性。手順2へ

#### パターンD: レスポンスは返ってくるが、内容がおかしい
```
Response text: {"success":false,"error":"システムエラーが発生しました"}
```

**原因:** Apps Script内部でエラーが発生している

**対処法:** 手順3でApps Scriptのログを確認

---

## 手順2: Apps Scriptのデプロイ設定を確認

### 1. Apps Scriptエディタを開く
1. Googleスプレッドシートを開く
2. 「拡張機能」→「Apps Script」をクリック

### 2. デプロイ状態を確認
1. 右上の「デプロイ」ボタンをクリック
2. 「デプロイを管理」を選択

### 3. 設定を確認
以下が正しく設定されているか確認:

| 項目 | 正しい設定 |
|------|-----------|
| 種類 | ウェブアプリ |
| 実行ユーザー | **自分** |
| アクセスできるユーザー | **全員** ← ここが重要！ |
| 状態 | アクティブ |

### 4. 設定が間違っている場合
1. 「デプロイを管理」で既存のデプロイを選択
2. 鉛筆アイコン（編集）をクリック
3. 「アクセスできるユーザー」を「**全員**」に変更
4. 「デプロイ」ボタンをクリック
5. **新しいURLが発行される場合があります**
6. 新しいURLを`script.js`の`SCRIPT_URL`に設定

---

## 手順3: Apps Scriptのログを確認

### 1. Apps Scriptエディタで実行
1. Apps Scriptエディタを開く
2. 関数選択で「**testSearchUser**」を選択
3. 「実行」ボタンをクリック
4. 権限の承認を求められたら、承認する

### 2. ログを確認
1. 「実行ログ」をクリック
2. 以下のようなログが表示されるか確認:

```
Testing with ID: user12345
Result: {"found":true,"hasAccess":true,"data":{...}}
```

### エラーが表示される場合

#### エラー: `Sheet not found: 入場者リスト`
**原因:** シート名が間違っている

**対処法:**
1. スプレッドシートに戻る
2. シートタブの名前を確認
3. 「**入場者リスト**」という名前のシートがあるか確認
4. ない場合は、シート名を「入場者リスト」に変更

#### エラー: `No data found in sheet`
**原因:** スプレッドシートにデータがない

**対処法:**
1. スプレッドシートにデータを入力
2. ヘッダー行（1行目）が正しく設定されているか確認

---

## 手順4: スプレッドシートの構造を確認

### 1. シート構造チェック
Apps Scriptエディタで以下を実行:
1. 関数選択で「**checkSheetStructure**」を選択
2. 「実行」ボタンをクリック
3. 実行ログを確認

### 2. 期待される出力
```
Sheet found: 入場者リスト
Number of rows: 4
Number of columns: 5
Header row: [CAMPFIRE_ID,氏名,リターン内容,入場権利,備考]
First data row: [user12345,山田太郎,入場券+グッズ,有,VIP席]
```

### 3. 正しいスプレッドシート構造

| A列 | B列 | C列 | D列 | E列 |
|-----|-----|-----|-----|-----|
| CAMPFIRE_ID | 氏名 | リターン内容 | 入場権利 | 備考 |
| user12345 | 山田太郎 | 入場券+グッズ | **有** | VIP席 |
| user67890 | 佐藤花子 | 入場券のみ | **有** |  |
| user11111 | 鈴木一郎 | グッズのみ | **無** | 入場権なし |

**重要なポイント:**
- 1行目は必ずヘッダー行
- A列（CAMPFIRE_ID）は必須
- D列（入場権利）は「**有**」または「**無**」の2文字で入力
- セルに余計なスペースや改行が入っていないこと

---

## 手順5: テストIDでの確認

### テストデータを追加
スプレッドシートに以下のテストデータを追加:

| CAMPFIRE_ID | 氏名 | リターン内容 | 入場権利 | 備考 |
|-------------|------|------------|---------|------|
| test123 | テストユーザー | テスト | 有 | テスト用 |

### ブラウザで確認
1. `index.html`をブラウザで開く
2. IDに「**test123**」と入力
3. 「入場権利を確認」ボタンをクリック
4. 緑色の「入場OK」画面が表示されるか確認

---

## よくある問題と解決策

### 問題: URLは正しいのにエラーになる

**解決策1: デプロイをやり直す**
1. Apps Scriptエディタで「デプロイ」→「新しいデプロイ」
2. 設定を再確認して新しくデプロイ
3. 新しいURLを`script.js`に設定
4. ブラウザのキャッシュをクリア（Ctrl+Shift+Delete）

**解決策2: 別のGoogleアカウントを試す**
- Apps Scriptの実行権限の問題の可能性
- 別のGoogleアカウントでスプレッドシートとApps Scriptを作り直す

### 問題: ローカルでは動くが、GitHub Pagesでは動かない

**原因:** Apps ScriptのURLが間違っている、またはCORS設定

**解決策:**
1. Apps ScriptのURLを再確認
2. `script.js`の`SCRIPT_URL`を確認
3. GitHub Pagesに最新版がプッシュされているか確認

### 問題: 一部のIDだけエラーになる

**原因:** データに不備がある

**解決策:**
1. スプレッドシートで該当行を確認
2. CAMPFIRE_IDに余計なスペースがないか確認
3. 入場権利が「有」または「無」になっているか確認
4. セルをコピペではなく、直接入力してみる

---

## それでも解決しない場合

### 最終手段: すべてやり直す

1. **新しいスプレッドシートを作成**
2. **Gas.jsのコードを新しくコピペ**
3. **Apps Scriptを新規デプロイ**
4. **新しいURLをscript.jsに設定**
5. **テストデータで動作確認**

### チェックリスト

- [ ] スプレッドシートのシート名が「入場者リスト」
- [ ] ヘッダー行が正しい
- [ ] テストデータが入力されている
- [ ] Apps Scriptのコードが正しくコピペされている
- [ ] デプロイ設定が「全員」
- [ ] デプロイURLが正しくscript.jsに設定されている
- [ ] ブラウザのキャッシュをクリアした
- [ ] ブラウザのコンソールでエラーログを確認した

---

## サポート情報の収集

それでも解決しない場合、以下の情報を収集してください:

1. **ブラウザのコンソールログ**（スクリーンショット）
2. **Apps Scriptの実行ログ**（スクリーンショット）
3. **スプレッドシートの構造**（checkSheetStructureの結果）
4. **使用しているブラウザ**（Chrome, Safari, Edgeなど）
5. **エラーが発生するタイミング**（常に、特定のIDのみ、など）

これらの情報があれば、より詳細な診断が可能です。
