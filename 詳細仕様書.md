# ライブ会場入場権利確認システム 詳細仕様書

## 1. システムアーキテクチャ

### 1.1 全体構成図
```
[スマートフォン]
     ↓ HTTPS
[GitHub Pages (HTML/CSS/JS)]
     ↓ HTTPS/CORS
[Google Apps Script]
     ↓ API
[Google スプレッドシート]
```

### 1.2 技術スタック詳細

| レイヤー | 技術 | 用途 |
|---------|------|------|
| フロントエンド | HTML5 | 画面構造 |
| フロントエンド | CSS3 (Flexbox) | スタイリング、レスポンシブ対応 |
| フロントエンド | JavaScript (Vanilla) | 入力処理、API通信 |
| ホスティング | GitHub Pages | 静的サイトホスティング |
| バックエンド | Google Apps Script | データ照合処理 |
| データストア | Google スプレッドシート | 入場権利データ管理 |

## 2. 画面仕様

### 2.1 共通仕様

#### 2.1.1 レイアウト
- ビューポート設定: `width=device-width, initial-scale=1.0`
- 最大幅: 600px (中央寄せ)
- パディング: 20px
- フォント: システムフォント (sans-serif)

#### 2.1.2 カラーパレット
- 背景色: `#f5f5f5`
- プライマリカラー: `#4CAF50` (入場OK)
- エラーカラー: `#f44336` (入場NG)
- テキストカラー: `#333333`
- ボーダーカラー: `#dddddd`

#### 2.1.3 レスポンシブブレークポイント
- モバイル: ~600px
- タブレット以上: 601px~

### 2.2 画面1: ID入力画面

#### 2.2.1 画面構成要素
```
┌─────────────────────────────┐
│       [ロゴ/タイトル]         │
│                             │
│    ライブ入場確認システム      │
│                             │
│  ┌─────────────────────┐   │
│  │ CAMPFIRE IDを入力    │   │
│  │                     │   │
│  │ [入力欄            ]│   │
│  │                     │   │
│  │   [確認ボタン]       │   │
│  └─────────────────────┘   │
│                             │
│  ※IDはCAMPFIREから通知された │
│   IDを入力してください        │
└─────────────────────────────┘
```

#### 2.2.2 HTML要素詳細
```html
<div class="container">
  <header>
    <h1>ライブ入場確認</h1>
    <p class="subtitle">CAMPFIRE IDで入場権利を確認</p>
  </header>
  
  <main>
    <div class="input-section">
      <label for="campfire-id">CAMPFIRE ID</label>
      <input 
        type="text" 
        id="campfire-id" 
        placeholder="IDを入力してください"
        autocomplete="off"
      >
      <button id="check-btn" class="btn-primary">入場権利を確認</button>
    </div>
    
    <div class="note">
      ※CAMPFIREから通知されたIDを入力してください
    </div>
  </main>
</div>
```

#### 2.2.3 スタイル仕様
- 入力欄
  - 高さ: 50px
  - フォントサイズ: 18px
  - ボーダー: 2px solid #ddd
  - 角丸: 8px
  - パディング: 10px 15px

- 確認ボタン
  - 高さ: 56px
  - フォントサイズ: 18px
  - 背景色: #2196F3
  - テキスト色: #ffffff
  - 角丸: 8px
  - タップエリア: 最小44x44px

### 2.3 画面2: 入場OK + リハ見学OK画面（パターン1）

#### 2.3.1 画面構成要素
```
┌─────────────────────────────┐
│                             │
│        ✓✓ (大きなアイコン)  │
│                             │
│   入場OK + リハ見学OK        │
│                             │
│  ようこそ!                   │
│  ライブ会場とリハーサル見学へ  │
│  お進みください              │
│                             │
│  [最初に戻るボタン]           │
│                             │
└─────────────────────────────┘
```

#### 2.3.2 HTML要素詳細
```html
<div class="container result-container success" id="success-both-screen">
  <div class="icon-wrapper">
    <div class="icon-success">✓✓</div>
  </div>

  <h2 class="result-title">入場OK + リハ見学OK</h2>

  <div class="result-message">
    <p>ようこそ!</p>
    <p>ライブ会場とリハーサル見学へお進みください</p>
  </div>

  <div class="user-info" id="user-info-both">
    <!-- ユーザー情報が表示される -->
  </div>

  <button class="btn-secondary" onclick="location.reload()">
    最初に戻る
  </button>
</div>
```

#### 2.3.3 スタイル仕様
- 背景色: 薄い緑 (#e8f5e9)
- アイコン
  - サイズ: 120px x 120px
  - 色: #4CAF50
  - 円形背景: 白
  - ボーダー: 4px solid #4CAF50

- タイトル
  - フォントサイズ: 32px
  - フォントウェイト: bold
  - 色: #4CAF50

### 2.4 画面3: 入場OK画面（パターン2: リハ見学NG）

#### 2.4.1 画面構成要素
```
┌─────────────────────────────┐
│                             │
│         ✓ (大きなアイコン)   │
│                             │
│      入場OK                 │
│                             │
│  ようこそ!                   │
│  ライブ会場へお進みください    │
│  ※リハーサル見学権利はありません │
│                             │
│  [最初に戻るボタン]           │
│                             │
└─────────────────────────────┘
```

#### 2.4.2 HTML要素詳細
```html
<div class="container result-container partial-success" id="success-entrance-only-screen">
  <div class="icon-wrapper">
    <div class="icon-partial">✓</div>
  </div>

  <h2 class="result-title">入場OK</h2>

  <div class="result-message">
    <p>ようこそ!</p>
    <p>ライブ会場へお進みください</p>
    <p class="notice">※リハーサル見学権利はありません</p>
  </div>

  <div class="user-info" id="user-info-entrance">
    <!-- ユーザー情報が表示される -->
  </div>

  <button class="btn-secondary" onclick="location.reload()">
    最初に戻る
  </button>
</div>
```

#### 2.4.3 スタイル仕様
- 背景色: 薄いオレンジ (#fff3e0)
- アイコン
  - サイズ: 120px x 120px
  - 色: #FF9800
  - 円形背景: 白
  - ボーダー: 4px solid #FF9800

- タイトル
  - フォントサイズ: 32px
  - フォントウェイト: bold
  - 色: #FF9800

- 注意書き
  - フォントサイズ: 16px
  - 色: #FF9800
  - フォントウェイト: bold

### 2.5 画面4: 入場NG画面（パターン3）

#### 2.4.1 画面構成要素
```
┌─────────────────────────────┐
│                             │
│         ✕ (大きなアイコン)   │
│                             │
│      入場NG                 │
│                             │
│  入場権利が確認できません     │
│  スタッフにお声がけください    │
│                             │
│  [最初に戻るボタン]           │
│                             │
└─────────────────────────────┘
```

#### 2.4.2 HTML要素詳細
```html
<div class="container result-container error">
  <div class="icon-wrapper">
    <div class="icon-error">✕</div>
  </div>
  
  <h2 class="result-title">入場NG</h2>
  
  <div class="result-message">
    <p>入場権利が確認できません</p>
    <p>スタッフにお声がけください</p>
  </div>
  
  <button class="btn-secondary" onclick="location.reload()">
    最初に戻る
  </button>
</div>
```

#### 2.4.3 スタイル仕様
- 背景色: 薄い赤 (#ffebee)
- アイコン
  - サイズ: 120px x 120px
  - 色: #f44336
  - 円形背景: 白
  - ボーダー: 4px solid #f44336

- タイトル
  - フォントサイズ: 32px
  - フォントウェイト: bold
  - 色: #f44336

### 2.5 ローディング表示

#### 2.5.1 表示要素
```html
<div class="loading-overlay">
  <div class="spinner"></div>
  <p>確認中...</p>
</div>
```

#### 2.5.2 スタイル仕様
- オーバーレイ: 半透明背景 rgba(0,0,0,0.5)
- スピナー: CSSアニメーション (回転)
- 表示タイミング: API通信中のみ

## 3. データ仕様

### 3.1 スプレッドシート構造

#### 3.1.1 シート名
`入場者リスト`

#### 3.1.2 列定義
| 列 | 列名 | データ型 | 制約 | 説明 | 例 |
|----|------|----------|------|------|-----|
| A | CAMPFIRE_ID | String | 必須、ユニーク | CAMPFIRE ID | "user12345" |
| B | 氏名 | String | 任意 | 支援者名 | "山田太郎" |
| C | リターン内容 | String | 任意 | 支援したリターン | "入場券+グッズ" |
| D | 入場権利 | String | 必須 | "有" または "無" | "有" |
| E | リハ見学権利 | String | 必須 | "有" または "無" | "有" |
| F | 備考 | String | 任意 | メモ等 | "VIP席" |

#### 3.1.3 データ例
```
CAMPFIRE_ID  | 氏名      | リターン内容    | 入場権利 | リハ見学権利 | 備考
-------------|-----------|----------------|----------|-------------|------
user12345    | 山田太郎   | 入場券+グッズ   | 有       | 有          | VIP席
user67890    | 佐藤花子   | 入場券のみ      | 有       | 無          |
user11111    | 鈴木一郎   | グッズのみ      | 無       | 無          | 入場権なし
```

### 3.2 API仕様

#### 3.2.1 エンドポイント
```
POST https://script.google.com/macros/s/{SCRIPT_ID}/exec
```

#### 3.2.2 リクエスト

**Content-Type**: `application/json`

**Body**:
```json
{
  "campfireId": "user12345"
}
```

**パラメータ**:
| パラメータ名 | 型 | 必須 | 説明 |
|------------|-----|------|------|
| campfireId | String | ◯ | CAMPFIRE ID |

#### 3.2.3 レスポンス

**パターン1: 入場権利=有、リハ見学権利=有 (200 OK)**:
```json
{
  "success": true,
  "hasAccess": true,
  "message": "入場権利とリハ見学権利があります",
  "pattern": "both",
  "data": {
    "name": "山田太郎",
    "returnItem": "入場券+グッズ",
    "rehearsalAccess": "有",
    "note": "VIP席"
  }
}
```

**パターン2: 入場権利=有、リハ見学権利=無 (200 OK)**:
```json
{
  "success": true,
  "hasAccess": true,
  "message": "入場権利があります",
  "pattern": "entrance_only",
  "data": {
    "name": "佐藤花子",
    "returnItem": "入場券のみ",
    "rehearsalAccess": "無",
    "note": null
  }
}
```

**パターン3: 入場権利=無 (200 OK)**:
```json
{
  "success": true,
  "hasAccess": false,
  "message": "入場権利がありません",
  "pattern": "none"
}
```

**IDが見つからない (200 OK)**:
```json
{
  "success": false,
  "hasAccess": false,
  "message": "該当するIDが見つかりません",
  "pattern": "not_found"
}
```

**エラー時 (500)**:
```json
{
  "success": false,
  "error": "システムエラーが発生しました"
}
```

## 4. 処理フロー

### 4.1 入場確認処理フロー

```
[ユーザー] ID入力
    ↓
[フロントエンド] 入力値検証
    ↓ (OK)
[フロントエンド] ローディング表示
    ↓
[フロントエンド] API呼び出し
    ↓
[Apps Script] リクエスト受信
    ↓
[Apps Script] スプレッドシート検索
    ↓
  該当データあり?
    ↓ Yes          ↓ No
入場権利="有"?      [Apps Script] エラーレスポンス
    ↓ Yes   ↓ No        ↓
[Apps Script]      [フロントエンド] エラー画面表示
OKレスポンス/NGレスポンス
    ↓
[フロントエンド] 結果画面表示
(OK画面 / NG画面)
```

### 4.2 フロントエンド処理詳細

#### 4.2.1 入力値検証
```javascript
function validateInput(campfireId) {
  // 空文字チェック
  if (!campfireId || campfireId.trim() === '') {
    return { valid: false, message: 'IDを入力してください' };
  }
  
  // 文字数チェック (例: 3文字以上50文字以下)
  if (campfireId.length < 3 || campfireId.length > 50) {
    return { valid: false, message: 'IDの形式が正しくありません' };
  }
  
  return { valid: true };
}
```

#### 4.2.2 API呼び出し
```javascript
async function checkAccess(campfireId) {
  const SCRIPT_URL = 'https://script.google.com/macros/s/{SCRIPT_ID}/exec';
  
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ campfireId: campfireId })
    });
    
    if (!response.ok) {
      throw new Error('通信エラー');
    }
    
    const data = await response.json();
    return data;
    
  } catch (error) {
    console.error('Error:', error);
    return { 
      success: false, 
      error: 'システムエラーが発生しました' 
    };
  }
}
```

### 4.3 バックエンド処理詳細 (Google Apps Script)

#### 4.3.1 メイン処理
```javascript
function doPost(e) {
  try {
    // リクエストパース
    const params = JSON.parse(e.postData.contents);
    const campfireId = params.campfireId;
    
    // 入力検証
    if (!campfireId) {
      return createResponse(false, false, 'IDが指定されていません');
    }
    
    // スプレッドシート検索
    const result = searchUser(campfireId);
    
    if (result.found) {
      if (result.hasAccess) {
        return createResponse(true, true, '入場権利があります', result.data);
      } else {
        return createResponse(true, false, '入場権利がありません');
      }
    } else {
      return createResponse(false, false, '該当するIDが見つかりません');
    }
    
  } catch (error) {
    Logger.log('Error: ' + error.message);
    return createResponse(false, false, 'システムエラーが発生しました');
  }
}
```

#### 4.3.2 スプレッドシート検索処理
```javascript
function searchUser(campfireId) {
  const SHEET_NAME = '入場者リスト';
  const sheet = SpreadsheetApp.getActiveSpreadsheet()
                               .getSheetByName(SHEET_NAME);
  
  // データ範囲取得
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  // ヘッダー行をスキップして検索
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const id = row[0]; // A列: CAMPFIRE_ID
    
    if (id === campfireId) {
      const name = row[1];        // B列: 氏名
      const returnItem = row[2];  // C列: リターン内容
      const access = row[3];      // D列: 入場権利
      
      return {
        found: true,
        hasAccess: access === '有',
        data: {
          name: name,
          returnItem: returnItem
        }
      };
    }
  }
  
  // 見つからない場合
  return { found: false };
}
```

#### 4.3.3 レスポンス生成
```javascript
function createResponse(success, hasAccess, message, data = null) {
  const response = {
    success: success,
    hasAccess: hasAccess,
    message: message
  };
  
  if (data) {
    response.data = data;
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}
```

## 5. エラー処理

### 5.1 エラー分類

| エラー種別 | 発生箇所 | 原因 | ユーザーへの表示 |
|-----------|---------|------|----------------|
| 入力エラー | フロントエンド | 空入力、不正な形式 | "IDを正しく入力してください" |
| 該当なしエラー | バックエンド | IDがスプレッドシートに存在しない | "該当するIDが見つかりません" |
| 権利なしエラー | バックエンド | 入場権利="無" | 入場NG画面表示 |
| 通信エラー | フロントエンド | ネットワーク障害 | "通信エラーが発生しました" |
| システムエラー | バックエンド | スクリプト実行エラー | "システムエラーが発生しました" |

### 5.2 エラー表示仕様

#### 5.2.1 入力エラー
- 入力欄の下に赤文字でメッセージ表示
- 入力欄を赤枠で強調
- アラート等のポップアップは使用しない

#### 5.2.2 システムエラー
```html
<div class="error-message">
  <p>⚠️ エラーが発生しました</p>
  <p class="error-detail">通信エラーが発生しました</p>
  <p class="error-action">しばらくしてから再度お試しください</p>
</div>
```

## 6. セキュリティ仕様

### 6.1 アクセス制御
- Google Apps ScriptのWeb App公開設定: 「誰でもアクセス可」
- スプレッドシートのアクセス権限: スクリプト実行者のみ閲覧/編集可
- CORS対応: Apps ScriptはCORSを自動的に許可(GitHub Pagesからのアクセス可能)

### 6.2 データ保護
- HTTPS通信の使用(GitHub Pages、Apps Script共に対応)
- スプレッドシートURLは非公開
- 個人情報の最小化(必要最小限のデータのみ取得)

### 6.3 不正アクセス対策
- レートリミット: Apps Scriptの標準制限に準拠
- 入力値のサニタイゼーション
- SQLインジェクション対策(Apps Scriptは該当しないが、入力値検証は実施)

### 6.4 GitHub Pages固有の考慮事項
- 静的サイトのため、サーバーサイドでの認証・認可は不可
- APIキー等の機密情報はフロントエンドに含めない
- Apps Script URLは公開されるが、スプレッドシート本体は保護される

## 6.5 プロジェクトファイル構成

### 6.5.1 GitHubリポジトリ構成
```
live-entrance-check/
├── index.html          # メインHTMLファイル
├── style.css           # スタイルシート
├── script.js           # JavaScript (API呼び出し、UI制御)
├── README.md           # プロジェクト説明
└── .gitignore          # Git除外設定 (任意)
```

### 6.5.2 ファイルサイズ目安
- index.html: 約5-8KB
- style.css: 約3-5KB
- script.js: 約5-8KB
- 合計: 約15-20KB (非常に軽量)

### 6.5.3 外部依存関係
- なし (完全スタンドアロン)
- CDN等の外部ライブラリは使用しない
- Vanilla JavaScriptのみで実装

## 7. デプロイ手順

### 7.1 準備作業

#### 7.1.1 スプレッドシート作成
1. Google スプレッドシートを新規作成
2. シート名を「入場者リスト」に変更
3. ヘッダー行を設定(A1:E1)
4. データを入力

#### 7.1.2 Apps Script設定
1. スプレッドシートから「拡張機能」→「Apps Script」を開く
2. コードを記述
3. プロジェクト名を設定

### 7.2 バックエンドデプロイ

#### 7.2.1 Apps Script デプロイ
1. Apps Scriptエディタで「デプロイ」→「新しいデプロイ」
2. 種類: ウェブアプリ
3. 設定:
   - 説明: ライブ入場確認API
   - 実行ユーザー: 自分
   - アクセスできるユーザー: 全員
4. デプロイ実行
5. **デプロイURLをコピー**(重要: フロントエンドで使用)

### 7.3 フロントエンドデプロイ (GitHub Pages)

#### 7.3.1 リポジトリ作成
1. GitHubで新規リポジトリを作成
   - リポジトリ名: `live-entrance-check` (任意)
   - Public設定
2. ローカルにクローン

#### 7.3.2 ファイル配置
```
/
├── index.html      (メインHTMLファイル)
├── style.css       (スタイルシート)
├── script.js       (JavaScript)
└── README.md       (説明文書)
```

#### 7.3.3 Apps Script URLの設定
`script.js`内の以下の部分を更新:
```javascript
const SCRIPT_URL = 'https://script.google.com/macros/s/{YOUR_SCRIPT_ID}/exec';
```

#### 7.3.4 GitHubへプッシュ
```bash
git add .
git commit -m "Initial commit: Live entrance check system"
git push origin main
```

#### 7.3.5 GitHub Pagesの有効化
1. GitHubリポジトリの「Settings」→「Pages」を開く
2. Source: Deploy from a branch
3. Branch: main (または master) / root
4. Save
5. 数分後に公開URLが表示される
   - 例: `https://username.github.io/live-entrance-check/`

### 7.4 QRコード作成
1. GitHub PagesのURLをコピー
2. QRコード生成サービスを使用してQRコード作成
3. 印刷してラミネート加工(推奨)
4. 会場に設置

### 7.5 動作確認
1. スマートフォンでQRコードを読み取る
2. ページが正しく表示されるか確認
3. テスト用IDで入場確認を実行
4. OK/NG画面が正しく表示されるか確認

## 8. テスト仕様

### 8.1 単体テスト

#### 8.1.1 フロントエンドテスト
| テスト項目 | 入力 | 期待結果 |
|-----------|------|---------|
| 正常入力 | "user12345" | API呼び出し成功 |
| 空入力 | "" | エラーメッセージ表示 |
| 短すぎるID | "ab" | エラーメッセージ表示 |
| 長すぎるID | 51文字以上 | エラーメッセージ表示 |

#### 8.1.2 バックエンドテスト
| テスト項目 | CAMPFIRE_ID | 入場権利 | 期待結果 |
|-----------|-------------|---------|---------|
| 正常(権利あり) | user12345 | 有 | hasAccess: true |
| 正常(権利なし) | user11111 | 無 | hasAccess: false |
| IDなし | user99999 | - | found: false |

### 8.2 統合テスト

#### 8.2.1 シナリオテスト
1. QRコード読み取り → ID入力画面表示
2. 有効なID入力 → 入場OK画面表示
3. 無効なID入力 → 該当なしエラー表示
4. 権利なしID入力 → 入場NG画面表示

### 8.3 デバイステスト
- iOS Safari (最新版)
- iOS Safari (1つ前のバージョン)
- Android Chrome (最新版)
- 画面サイズ: 375px~428px (主要スマートフォン)

## 9. 運用仕様

### 9.1 事前準備(イベント1週間前)
- [ ] スプレッドシートにデータ登録完了
- [ ] Apps Scriptデプロイ完了
- [ ] QRコード印刷・設置準備
- [ ] 動作確認テスト実施
- [ ] スタッフへの使用方法説明

### 9.2 当日運用
- [ ] 会場Wi-Fi動作確認
- [ ] QRコード設置
- [ ] 予備端末準備(スタッフ用)
- [ ] 緊急連絡体制確認

### 9.3 トラブルシューティング

| 問題 | 対処法 |
|------|--------|
| ネット接続不良 | Wi-Fi再接続、モバイル回線切替 |
| システムエラー | ブラウザリロード、Apps Script再デプロイ |
| ID不明 | スタッフが手動でスプレッドシート確認 |

## 10. パフォーマンス要件

### 10.1 レスポンスタイム
- ID入力→結果表示: 3秒以内(通常)、5秒以内(最大)
- ローディング表示: 1秒以上処理がかかる場合

### 10.2 同時アクセス
- 想定: 小規模会場向け(10-20人程度の同時アクセス)
- Apps Script実行回数制限: 1日あたり20,000回まで
- 大規模会場での高負荷動作は保証対象外

### 10.3 制限事項
- GitHub Pagesは静的サイトホスティングのため、サーバーサイドキャッシュ等は利用不可
- バックエンドはGoogle Apps Scriptの制限に準拠

## 11. 保守・更新

### 11.1 データ更新
- スプレッドシートは管理者が直接編集
- 更新後の再デプロイは不要(リアルタイム反映)

### 11.2 バージョン管理
- Apps Scriptのバージョン管理機能を活用
- 重要な変更前にバージョンを保存

## 12. 付録

### 12.1 README.mdサンプル

```markdown
# ライブ入場確認システム

CAMPFIRE IDを使用してライブ会場の入場権利を確認するWebアプリケーションです。

## 機能

- CAMPFIRE IDの入力と照合
- 入場OK/NG画面の表示
- スマートフォン最適化UI

## 技術スタック

- フロントエンド: HTML5, CSS3, Vanilla JavaScript
- バックエンド: Google Apps Script
- ホスティング: GitHub Pages
- データ管理: Google スプレッドシート

## デモ

[デモサイト](https://username.github.io/live-entrance-check/)

## セットアップ

### 1. スプレッドシート準備
1. Google スプレッドシートを作成
2. 「入場者リスト」シートを作成
3. データを登録

### 2. Apps Script デプロイ
1. スプレッドシートから Apps Script を開く
2. コードをデプロイ
3. デプロイURLを取得

### 3. フロントエンド設定
1. `script.js`の`SCRIPT_URL`を更新
2. GitHubにプッシュ
3. GitHub Pagesを有効化

## 使い方

1. QRコードをスキャン
2. CAMPFIRE IDを入力
3. 入場権利を確認

## ライセンス

MIT License

## 作成者

[Your Name]
```

### 12.2 .gitignoreサンプル

```
# macOS
.DS_Store

# Windows
Thumbs.db

# Editor
.vscode/
.idea/

# Logs
*.log

# 環境変数ファイル（使用する場合）
.env
```

---

**作成日**: 2025年11月19日  
**バージョン**: 1.1 (GitHub Pages対応版)  
**作成者**: システム設計担当